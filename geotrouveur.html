<html>
<head>
<link rel="stylesheet" href="geotrouveur.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
/*

 progression
  
 // effacer les choix si une partie simple est lancé
  
 Test local avec : python -m http.server
*/

var nomLocalStorage = 'ilmion.geographie';
var currentVersion = '1';
var geographie = undefined;

var idJeu = null;
var listElementComplet = [];
var listElementATrouver = [];
var elementATrouver = null;
var succes = 0;
var erreur = 0;
var lastNotif = null;

var jeuxDisponibles = {
	'region' : {
		'nom':'R&eacute;gions administratives',
		'image':'jeux/Regions Administratives.gif',
		'svg':'jeux/Regions Administratives.html'
	},
	'province' :{
		'nom':'Provinces du Canada',
		'image':'jeux/Provinces Canadiennes.gif',
		'svg':'jeux/Provinces Canadiennes.html'
	},
	'capitale' :{
		'nom':'Capitales du Canada',
		'image':'jeux/Capitales Canadiennes.gif',
		'svg':'jeux/Capitales Canadiennes.html'
	},
};

function saveLocalStorage() {
	localStorage.setItem(nomLocalStorage, JSON.stringify(geographie));
}

function initJeuGlobalEtLocalStorage(pIdJeu) {
	idJeu = pIdJeu;
	if(geographie[idJeu] == undefined) {
		geographie[idJeu] = {};
	}
	if(geographie[idJeu].simple == undefined) {
		geographie[idJeu].simple = {};
		geographie[idJeu].simple.erreurRecord = -1;
	}
	if(geographie[idJeu].progression == undefined) {
		geographie[idJeu].progression = {};
		geographie[idJeu].progression.elementsATrouver = [];
		geographie[idJeu].progression.succesConsecutif = 0;
		geographie[idJeu].progression.type = null;
	}
}

function chargement(){
	geographie = JSON.parse(localStorage.getItem(nomLocalStorage));
	if(geographie == undefined) {
		geographie = {};
		geographie.version = currentVersion;
		console.log('geographie', geographie);
		saveLocalStorage();
	}
	
	
	for(const [key, jeu] of Object.entries(jeuxDisponibles)){
	    $('#menu').append('<button type="button" class="button" onclick="chargerJeu(\'' + key + '\')">' + jeu.nom + '</button>');
	}
	
	chargerJeu('region');
	
	
}

function chargerJeu(pIdJeu){
	console.log('chargerJeu', pIdJeu);
	initJeuGlobalEtLocalStorage(pIdJeu);

	resetSuccesEtErreur();
	
	var lastNotif = null;
	$('#tableau-reussi').empty();
	$('#svg-carte').removeClass('started');
	$('#element-a-trouver').empty();
	$('#erreur-record').css('display', 'none');
	$('#erreur-record-texte').css('display', 'none');
	
	$('#btn-start').html('Commencer partie simple');
	
	if(geographie[idJeu].progression.elementsATrouver.length > 0){
		$('#btn-start-etape').html('Continuer apprentissage par &eacute;tape');
	}
	else {
		$('#btn-start-etape').html('Commencer apprentissage par &eacute;tape');
	}	
	
	$('#choixEtape').css('display', 'none');
	
	declancherChaineDeChargement();
}

function declancherChaineDeChargement() {
	$('#img-carte').empty();
	var theCachedImage = new Image();
	theCachedImage.id = "img-carte";
	$(theCachedImage).on( "load", onImageCharger );
	theCachedImage.src = jeuxDisponibles[idJeu].image;
}

function onImageCharger(e){
	$('#img-carte').append(e.target);
	$.ajax(jeuxDisponibles[idJeu].svg, { success: function(response) { onSVGCharger(response, e.target) } } );
}

function onSVGCharger(response, image) {
	$('#svg-carte').empty();
	$('#svg-carte').html(response);
	$('#svg-carte svg').attr('width', image.width);
	$('#svg-carte svg').attr('height', image.height);
	$('#carte-et-svg').css('width', image.width);
	$('#carte-et-svg').css('height', image.height);
	
	initListElementComplet();
	$('#jeux').css('display','block');
}

function initListElementComplet() {
	listElementComplet = [];
	$('#svg-carte svg').children('path').each(function () {
		let element = $(this).attr('id');
		if(!element.includes('{')) {
			//let indexCrochetFermant = element.indexOf(']');
			//if(indexCrochetFermant == -1) {
			listElementComplet.push(element);
			//}
			//else {
			//	listElementComplet.push(element.substring(indexCrochetFermant)+1);
			//}
		}
	});
	listElementComplet.sort();
}

function initListElementATrouver() {	
	listElementATrouver = [];
	for(var element of listElementComplet) {
		listElementATrouver.push(element);
	}
	elementATrouver = null;
}

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

function removeAllClick(){
	$('#svg-carte svg').children('path').each(function () {
		$(this).off('click');
	});
}

function start(){
	$('#choixEtape').css('display', 'none');
	removeClassToAllRegionPath('erreur-region');
	removeClassToAllRegionPath('reussi');
	
	retirerDernierNotif();

	initListElementATrouver();
	construireTableauReussi();
	
	shuffleArray(listElementATrouver);
	elementATrouver = listElementATrouver.shift();
	
	removeAllClick();
	$('#svg-carte svg').children('path').each(function () {
		var idRegion = $(this).attr('id');
		if(idRegion.includes('[')) {
			addClassToRegionPath(idRegion, 'no-hover');
		}
		else {
			if(idRegion.includes('{')) {
				idCible = trouverElementCible(idRegion);
				$(this).hover(
					function() {
						addClassToRegionPath(idCible, 'fake-hover');
					},
					function() {
						removeClassToRegionPath(idCible, 'fake-hover');
					}
				)
			}
			
			$(this).click(function() {
				regionClick(idRegion);
			});
		} 
	});
	
	$('#svg-carte').addClass('started');
	$('#element-a-trouver').html(decoderNomElement(elementATrouver));
	resetSuccesEtErreur();
	
	if(geographie[idJeu].simple.erreurRecord != -1){
		$('#erreur-record').html(geographie[idJeu].simple.erreurRecord);
		$('#erreur-record').css('display', 'inline');
		$('#erreur-record-texte').css('display', 'inline');
	}
	else {
		$('#erreur-record').css('display', 'none');
		$('#erreur-record-texte').css('display', 'none');
	}
	
	$('#btn-start').html('Recommencer');
}

function trouverElementCible(idElement){
	console.log('idElement',idElement);
	let indexDebut = idElement.indexOf('{');
	let indexFin = idElement.indexOf('}');
	let cible = '[' + idElement.substring(indexDebut+1, indexFin) + ']';
	let elementCible = null;
	$('#svg-carte svg').children('path').each(function () {
		if($(this).attr('id').includes(cible)){
			elementCible = $(this).attr('id');
			return false;
		}
	});
	console.log('elementCible',elementCible);
	return elementCible;
}

function resetSuccesEtErreur(){
	succes = 0;
	erreur = 0;
	$('#succes').html(succes);
	$('#erreur').html(erreur);
}

function construireTableauReussi() {
	$('#tableau-reussi').empty();
	$('#tableau-reussi').append('<table>');
	for(var element of listElementATrouver){
		$('#tableau-reussi').append('<tr><td><span id="reussi-' + element + '">' + decoderNomElement(element) + '</span></td></tr>');
	}
	$('#tableau-reussi').append('</table>');
}

function decoderNomElement(idElement){
	let indexCrochetFermant = idElement.indexOf('[');
	if(indexCrochetFermant == -1) {
		return idElement;
	}
	else {
		return idElement.substring(0, indexCrochetFermant);
	}
}

function startParEtape(){
	$('#btn-start').html('Commencer partie simple');
	retirerDernierNotif();
	$('#tableau-reussi').empty();
	$('#svg-carte').removeClass('started');
	$('#element-a-trouver').empty();
	$('#erreur-record').css('display', 'none');
	$('#erreur-record-texte').css('display', 'none');

	
	$('#choixEtape').css('display', 'inherit');
}

function choixParEtape(){
	// TODO : Prendre le target et en déduire le type. target.dataset.type
}

// TODO : Ajouter le trouvage de la cible
function regionClick(regionChoisi){
	if(elementATrouver != null) {
		let cible = regionChoisi;
		if(regionChoisi.includes('{')){
			cible = trouverElementCible(regionChoisi);
		}
		console.log('regionChoisi: '+ regionChoisi + ', elementATrouver: ' + elementATrouver);
		if(cible == elementATrouver) {
			succes++;
			$('#succes').html(succes);
			
			addClassToRegionPath(cible, 'reussi');
			
			removeClassToAllRegionPath('erreur-region');
			var idReussi = "span[id='reussi-" + cible + "']";
			$(idReussi).addClass('reussi');
			
			const index = listElementATrouver.indexOf(elementATrouver);
			if (index > -1) {
				listElementATrouver.splice(index, 1);
			}
			if(listElementATrouver.length == 0){
				if(geographie[idJeu].simple.erreurRecord == -1 || erreur < geographie[idJeu].simple.erreurRecord) {
					console.log('succes on sauve');
					geographie[idJeu].simple.erreurRecord = erreur;
					saveLocalStorage();
				}
				$('#svg-carte').removeClass('started');
				$('#element-a-trouver').empty();
				afficherNotif("complet", null, true);
			}
			else {
				afficherNotif('succes', function() {
					console.log('cible', cible);
					removeClassToRegionPath(cible, 'reussi');
					elementATrouver = listElementATrouver[Math.floor(Math.random()*listElementATrouver.length)];
					console.log('Element a trouver' + elementATrouver);
					$('#element-a-trouver').html(decoderNomElement(elementATrouver));
				});				
			}
		}
		else {
			erreur++;
			$('#erreur').html(erreur);	
			addClassToRegionPath(regionChoisi, 'erreur-region');
			afficherNotif('erreur');			
		}
	}
}

function afficherNotif(notifType, callback=null, stay=false){
	lastNotif = notifType;
	$('#notif').addClass(notifType);
	$('#svg-carte').removeClass('started');
	if(!stay){
		setTimeout(function() {
				retirerDernierNotif();
				$('#svg-carte').addClass('started');
				if(callback != null) {
					callback();
				}
			}, 1000);
	}
}

function retirerDernierNotif(){
	if(lastNotif != null){
		$('#notif').removeClass(lastNotif);
		lastNotif = null;
	}
}

function addClassToRegionPath(idRegion, nomClass){
	$('#svg-carte svg').children('path').each(function () {
		if($(this).attr('id') == idRegion) {
			var newClass = '';
			if($(this).attr('class') != undefined) {
				newClass = $(this).attr('class') + ' ' + nomClass; 
			}
			else {
				newClass = nomClass; 
			}
			$(this).attr('class', newClass);
			return false;
		}
	});
}

function removeClassToRegionPath(idRegion, nomClass){
	$('#svg-carte svg').children('path').each(function () {
		if($(this).attr('id') == idRegion) {
			var newClass = $(this).attr('class').replace(nomClass, '').trim();
			$(this).attr('class', newClass);
			return false;
		}
	});
}

function removeClassToAllRegionPath(nomClass){
	$('#svg-carte svg').children('path').each(function () {
		var actualClass = $(this).attr('class');
		if(actualClass != undefined) {
			var newClass = $(this).attr('class').replace(nomClass, '').trim();
			$(this).attr('class', newClass);
		}
	});
}
</script>

</head>
<body onload="chargement();">
	<div id="menu"></div>
	<div id="jeux" style="display:none">
		<div id="entete">
			<button id="btn-start" type="button" class="button" onclick="start()"></button>
			<!--<button id="btn-start-etape" type="button" class="button" onclick="startParEtape()"></button>-->
		</div>
		<div id="choixEtape">
			<span>Le mode part &eacute;tapes permet d'apprendre progressivement. Vous commencez avec un nombre r&eacute;duit d'&eacute;l&eacute;ments &agrave; trouver. Apr&egrave;s une s&eacute;rie de succ&egrave;s d'autre &eacute;l&eacute;ments sont ajout&eacute;s. Ainsi de suite.</span>
			<div id="lesChoixEtape">
				<div><button id="choixRapide" class="button btn-choix" onclick="choixParEtape()" data-type="rapide"><span class="buttonTitre">Rapide</span><span class="buttonDescription">D&eacute;part : 5, Succ&egrave;s pour avancement : 1, Ajout&eacute;s : 3</span></button></div>
				<div><button id="choixMoyen" class="button btn-choix" onclick="choixParEtape()" data-type="moyen"><span class="buttonTitre">Moyen</span><span class="buttonDescription">D&eacute;part : 3, Succ&egrave;s pour avancement : 2, Ajout&eacute;s : 2</span></button></div>
				<div><button id="choixLent" class="button btn-choix" onclick="choixParEtape()" data-type="lent"><span class="buttonTitre">Lent</span><span class="buttonDescription">D&eacute;part : 3, Succ&egrave;s pour avancement : 2, Ajout&eacute;s : 1</span></button></div>
			</div>
		</div>
		<span id="element-a-trouver"></span>
		<div id="carte-resultat">
			<div id="carte-et-svg">
				<div id="notif"></div>
				<div id="img-carte"></div>
				<div id="svg-carte"></div>
			</div>
			<div id="tableau-reussi"></div>
		</div>
		<div id="statut">
			<div><span>Succes : </span><span id="succes"></span></div>
			<div><span>Erreur : </span><span id="erreur"></span></div>
			<div><span id="erreur-record-texte">Reccord d'erreur : </span><span id="erreur-record"><span></div>
		</div>	
	</div>
</body>
</html>